name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:    # â† Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ Ğ£Ğ§ĞĞĞ™ Ğ—ĞĞŸĞ£Ğ¡Ğš
    inputs:
      version:
        description: 'Version for the package'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package for Linux
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          qt6-base-dev \
          qt6-declarative-dev \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql-client \
          devscripts \
          debhelper \
          dpkg-dev

    - name: ğŸ”§ Configure project
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: ğŸ—ï¸ Build project
      run: |
        cd build
        make -j$(nproc)

    - name: ğŸ“¦ Create .deb package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager
        
        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ¸Ğ· Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ¸Ğ»Ğ¸ Ñ‚ĞµĞ³Ğ°
        PACKAGE_VERSION="${{ github.event.inputs.version || github.ref_name }}"
        echo "Building version: $PACKAGE_VERSION"
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ control Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹
        cat > package/DEBIAN/control << EOF
        Package: fridgemanager
        Version: $PACKAGE_VERSION
        Architecture: amd64
        Maintainer: GitHub Actions <actions@github.com>
        Depends: libqt6core6, libqt6qml6, libqt6quick6, postgresql-client, libpq5
        Section: utils
        Priority: optional
        Description: Restaurant fridge inventory manager
         Track products in restaurant fridge with PostgreSQL support.
        EOF
        
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        chmod 755 package/usr/bin/fridgemanager

    - name: ğŸ Build .deb package
      run: |
        PACKAGE_VERSION="${{ github.event.inputs.version || github.ref_name }}"
        dpkg-deb --build package fridgemanager_${PACKAGE_VERSION}_amd64.deb
        
        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°ĞºĞµÑ‚Ğµ
        dpkg --info fridgemanager_${PACKAGE_VERSION}_amd64.deb
        echo "ğŸ“¦ Package created: fridgemanager_${PACKAGE_VERSION}_amd64.deb"

    - name: ğŸ·ï¸ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: fridgemanager_${{ github.ref_name }}_amd64.deb

    - name: ğŸ“¤ Upload artifact (for manual runs)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-package
        path: fridgemanager_${{ github.event.inputs.version }}_amd64.deb
        retention-days: 30
