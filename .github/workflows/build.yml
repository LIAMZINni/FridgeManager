name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package
    runs-on: ubuntu-22.04
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Install build dependencies
      run: |
        sudo apt-get update
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Qt5 development environment –¥–ª—è Ubuntu 22.04
        sudo apt-get install -y \
          qtbase5-dev \
          qtchooser \
          qt5-qmake \
          qtbase5-dev-tools \
          qttools5-dev-tools \
          qtdeclarative5-dev \
          qml-module-qtquick2 \
          qml-module-qtquick-window2 \
          qml-module-qtquick-controls2 \
          qml-module-qtquick-layouts \
          qml-module-qtquick-dialogs \
          qtquickcontrols2-5-dev \
          libqt5sql5-psql \
        # –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql \
          postgresql-client \
        # –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–∞–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        sudo apt-get install -y \
          devscripts \
          debhelper \
          dpkg-dev

    - name: üîß Build project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: üì¶ Create package structure
      run: |
        # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–∫–µ—Ç–∞
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager

        # –°–æ–∑–¥–∞–µ–º control —Ñ–∞–π–ª
        cat > package/DEBIAN/control << 'EOF'
        Package: fridgemanager
        Version: 1.0.0
        Architecture: amd64
        Maintainer: GitHub Actions <actions@github.com>
        Depends: postgresql, libqt5core5, libqt5qml5, libqt5quick5, libqt5sql5-psql, libpq5
        Section: utils
        Priority: optional
        Description: Restaurant fridge manager with PostgreSQL
        Automatic database setup and product inventory management.
        Features:
          - Auto-creates PostgreSQL database
          - Product inventory tracking
          - Supplier order generation
          - Modern QML interface
        EOF

        # –°–æ–∑–¥–∞–µ–º postinst —Å–∫—Ä–∏–ø—Ç (–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
        cat > package/DEBIAN/postinst << 'EOF'
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "   –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FridgeManager"
        echo "=========================================="

        # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
        chmod 755 /usr/bin/fridgemanager

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ PostgreSQL
        if ! command -v psql &> /dev/null; then
            echo "‚ùå PostgreSQL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt-get install postgresql"
            exit 1
        fi

        # –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL
        echo "üîß –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL..."
        systemctl start postgresql || true
        systemctl enable postgresql || true

        # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
        sleep 3

        # –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        echo "üóÑÔ∏è –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
        sudo -u postgres createdb fridgemanager 2>/dev/null && echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞" || echo "üìÅ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        echo "üìä –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤..."
        sudo -u postgres psql -d fridgemanager -c "
        CREATE TABLE IF NOT EXISTS products (
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            current_quantity INTEGER NOT NULL DEFAULT 0,
            norm_quantity INTEGER NOT NULL
        );" 2>/dev/null && echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞" || echo "üìã –¢–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        echo "üìù –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ..."
        sudo -u postgres psql -d fridgemanager -c "
        INSERT INTO products (name, current_quantity, norm_quantity) VALUES
        ('–¢–≤–æ—Ä–æ–≥', 5, 10),
        ('–°—ã—Ä', 12, 15), 
        ('–ú–æ–ª–æ–∫–æ', 18, 20),
        ('–Ø–π—Ü–∞', 25, 30),
        ('–û–ª–∏–≤–∫–∏', 3, 8)
        ON CONFLICT (name) DO NOTHING;" 2>/dev/null && echo "‚úÖ –î–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã" || echo "üìä –î–∞–Ω–Ω—ã–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç"

        echo ""
        echo "üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "‚û°Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–µ: fridgemanager"
        echo "=========================================="
        EOF

        # –°–æ–∑–¥–∞–µ–º prerm —Å–∫—Ä–∏–ø—Ç (–ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º)
        cat > package/DEBIAN/prerm << 'EOF'
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "   –£–¥–∞–ª–µ–Ω–∏–µ FridgeManager"
        echo "=========================================="

        if [ "$1" = "remove" ] || [ "$1" = "deconfigure" ]; then
            read -p "‚ùì –£–¥–∞–ª–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö fridgemanager? [y/N]: " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
                sudo -u postgres dropdb --if-exists fridgemanager 2>/dev/null || true
                echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–∞"
            fi
    
            echo "üßπ –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
            rm -rf /etc/fridgemanager 2>/dev/null || true
            rm -rf /var/lib/fridgemanager 2>/dev/null || true
        fi

        echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        EOF

        # –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
        chmod 755 package/usr/bin/fridgemanager
        chmod 755 package/DEBIAN/postinst
        chmod 755 package/DEBIAN/prerm

    - name: üéÅ Build deb package
      run: |
        # –°–æ–±–∏—Ä–∞–µ–º –ø–∞–∫–µ—Ç
        dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–∫–µ—Ç
        echo "üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ:"
        dpkg --info fridgemanager_1.0.0_amd64.deb
        
        echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–∫–µ—Ç–∞:"
        dpkg -c fridgemanager_1.0.0_amd64.deb
        
        echo "‚úÖ –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞: $(du -h fridgemanager_1.0.0_amd64.deb | cut -f1)"

        - name: üß™ Test package installation
      
        run: |
        echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–∞..."
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç
        sudo dpkg -i fridgemanager_1.0.0_amd64.deb || true
        
        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        sudo apt-get install -f -y
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å
        if command -v fridgemanager &> /dev/null; then
            echo "‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: fridgemanager"
        else
            echo "‚ùå –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
            exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ë–î —Å–æ–∑–¥–∞–Ω–∞
        if sudo -u postgres psql -l | grep -q fridgemanager; then
            echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞"
        else
            echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞
        if sudo -u postgres psql -d fridgemanager -c "SELECT * FROM products LIMIT 1;" &> /dev/null; then
            echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–∞"
        else
            echo "‚ùå –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
        fi

 
   
        
        - name: üè∑Ô∏è Create GitHub Release
           if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
        files: fridgemanager_${{ github.ref_name }}_amd64.deb
        body: |
          ## Fridge Manager ${{ github.ref_name }}
          
          ### üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
          - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ PostgreSQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          - –£—á–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
          - –ü—Ä–∏—Ö–æ–¥ –∏ —Ä–∞—Å—Ö–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É
          - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π QML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          
          ### üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
          ```bash
          sudo dpkg -i fridgemanager_${{ github.ref_name }}_amd64.deb
          ```
          
          –ü–∞–∫–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
          - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç PostgreSQL –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          - –°–æ–∑–¥–∞—Å—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö `fridgemanager`
          - –°–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          - –î–æ–±–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
          
          ### üéØ –ó–∞–ø—É—Å–∫:
          ```bash
          fridgemanager
          ```

    - name: üì§ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-deb-package
        path: fridgemanager_1.0.0_amd64.deb
        retention-days: 30