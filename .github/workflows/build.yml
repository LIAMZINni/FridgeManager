name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake qt6-base-dev qt6-declarative-dev libgl1-mesa-dev libpq-dev postgresql-client devscripts debhelper dpkg-dev

    - name: Build project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Create package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager

        # Create control file
        cat > package/DEBIAN/control << 'EOF'
        Package: fridgemanager
        Version: 1.0.0
        Architecture: amd64
        Maintainer: GitHub Actions
        Depends: libqt6core6, libqt6qml6, libqt6quick6, postgresql-client, libpq5
        Section: utils
        Priority: optional
        Description: Restaurant fridge manager
        EOF

        # Copy files
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        chmod 755 package/usr/bin/fridgemanager

    - name: Build deb package
      run: |
        dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
        dpkg --info fridgemanager_1.0.0_amd64.deb

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-deb
        path: fridgemanager_1.0.0_amd64.deb