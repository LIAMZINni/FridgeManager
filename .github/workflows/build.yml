name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
    workflow_dispatch:    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
jobs:
  build-linux:
    name: Build .deb package for Linux
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          qt6-base-dev \
          qt6-declarative-dev \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql-client \
          devscripts \
          debhelper \
          dpkg-dev

    - name: ğŸ”§ Configure project
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: ğŸ—ï¸ Build project
      run: |
        cd build
        make -j$(nproc)

    - name: ğŸ“¦ Create .deb package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager
        cp package/DEBIAN/control package/DEBIAN/
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        chmod 755 package/usr/bin/fridgemanager

    - name: ğŸ Build .deb package
      run: |
        dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
        dpkg --info fridgemanager_1.0.0_amd64.deb

    - name: ğŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: fridgemanager_1.0.0_amd64.deb
