name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qtbase5-dev \
          qt5-qmake \
          qtdeclarative5-dev \
          qml-module-qtquick2 \
          qml-module-qtquick-window2 \
          qml-module-qtquick-controls2 \
          qml-module-qtquick-layouts \
          qml-module-qtquick-dialogs \
          libqt5sql5-psql \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql \
          postgresql-client \
          devscripts \
          debhelper \
          dpkg-dev

    - name: ğŸ”§ Build project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: ğŸ“¦ Create package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager

    - name: ğŸ“ Create control file
      run: |
        cat << 'CONTROL_EOF' > package/DEBIAN/control
        Package: fridgemanager
        Version: 1.0.0
        Architecture: amd64
        Maintainer: GitHub Actions <actions@github.com>
        Depends: postgresql, libqt5core5a, libqt5qml5, libqt5quick5, libqt5sql5-psql, libpq5, qml-module-qtquick2, qml-module-qtquick-window2, qml-module-qtquick-controls2
        Section: utils
        Priority: optional
        Description: Restaurant fridge manager with PostgreSQL
         Automatic database setup and product inventory management.
         Features:
          - Auto-creates PostgreSQL database
          - Product inventory tracking
          - Supplier order generation
          - Modern QML interface
        CONTROL_EOF

            - name: ğŸ“ Create postinst script
              run: |
                cat << 'POSTINST_EOF' > package/DEBIAN/postinst
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "   Setting up FridgeManager"
        echo "=========================================="

        # Make executable
        chmod 755 /usr/bin/fridgemanager

        # Check PostgreSQL
        if ! command -v psql &> /dev/null; then
            echo "âŒ PostgreSQL not found!"
            exit 1
        fi

        echo "ğŸ”§ Starting PostgreSQL..."
        sudo systemctl start postgresql || true
        sudo systemctl enable postgresql || true

        # Wait for PostgreSQL to start
        sleep 5

        echo "ğŸ—„ï¸ Creating database..."
        sudo -u postgres createdb fridgemanager 2>/dev/null && echo "âœ… Database created" || echo "ğŸ“ Database already exists"

        echo "ğŸ“Š Creating products table..."
        sudo -u postgres psql -d fridgemanager -c "
        CREATE TABLE IF NOT EXISTS products (
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            current_quantity INTEGER NOT NULL DEFAULT 0,
            norm_quantity INTEGER NOT NULL
        );" 2>/dev/null && echo "âœ… Table created" || echo "ğŸ“‹ Table already exists"

        echo "ğŸ“ Adding sample data..."
        sudo -u postgres psql -d fridgemanager -c "
        INSERT INTO products (name, current_quantity, norm_quantity) VALUES
        ('Ğ¢Ğ²Ğ¾Ñ€Ğ¾Ğ³', 5, 10),
        ('Ğ¡Ñ‹Ñ€', 12, 15),
        ('ĞœĞ¾Ğ»Ğ¾ĞºĞ¾', 18, 20),
        ('Ğ¯Ğ¹Ñ†Ğ°', 25, 30),
        ('ĞĞ»Ğ¸Ğ²ĞºĞ¸', 3, 8)
        ON CONFLICT (name) DO NOTHING;" 2>/dev/null && echo "âœ… Data added" || echo "ğŸ“Š Data already exists"

        echo ""
        echo "ğŸ‰ Setup completed!"
        echo "â¡ï¸ Run: fridgemanager"
        echo "=========================================="
        POSTINST_EOF

            - name: ğŸ“ Create prerm script
              run: |
                cat << 'PRERM_EOF' > package/DEBIAN/prerm
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "   Removing FridgeManager"
        echo "=========================================="

        if [ "$1" = "remove" ] || [ "$1" = "deconfigure" ]; then
            echo "ğŸ§¹ Cleaning up..."
    
            # Remove config files
            rm -rf /etc/fridgemanager 2>/dev/null || true
            rm -rf /var/lib/fridgemanager 2>/dev/null || true
            rm -rf /tmp/fridgemanager 2>/dev/null || true
    
            echo "âœ… Cleanup completed"
        fi
        PRERM_EOF

            - name: ğŸ“ Copy program files
              run: |
                cp build/FridgeManager package/usr/bin/fridgemanager
                cp Main.qml package/usr/share/fridgemanager/
                chmod 755 package/usr/bin/fridgemanager
                chmod 755 package/DEBIAN/postinst
                chmod 755 package/DEBIAN/prerm

            - name: ğŸ Build deb package
              run: |
                dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
                dpkg --info fridgemanager_1.0.0_amd64.deb
                echo "ğŸ“¦ Package size: $(du -h fridgemanager_1.0.0_amd64.deb | cut -f1)"

    - name: ğŸ§ª Test package installation
      run: |
        echo "ğŸ§ª Testing package installation..."
        
        # Install the package
        sudo dpkg -i fridgemanager_1.0.0_amd64.deb || true
        
        # Fix dependencies
        sudo apt-get update
        sudo apt-get install -f -y
        
        # Test if program is installed
        if command -v fridgemanager &> /dev/null; then
            echo "âœ… Program installed successfully"
            
            # Test database setup
            echo "ğŸ§ª Testing database setup..."
            sudo -u postgres psql -d fridgemanager -c "SELECT COUNT(*) FROM products;" && echo "âœ… Database accessible" || echo "âŒ Database error"
            
            # Show products
            echo "ğŸ“Š Products in database:"
            sudo -u postgres psql -d fridgemanager -c "SELECT name, current_quantity, norm_quantity FROM products;"
            
        else
            echo "âŒ Program installation failed"
            exit 1
        fi

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-deb-package
        path: fridgemanager_1.0.0_amd64.deb
        retention-days: 30

    - name: ğŸ·ï¸ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: fridgemanager_1.0.0_amd64.deb
        body: |
          ## Fridge Manager ${{ github.ref_name }}
          
          ### Features:
          - âœ… Automatic PostgreSQL database creation
          - âœ… Product inventory management
          - âœ… Supplier order generation
          - âœ… Modern QML interface
          
          ### Installation:
          ```bash
          sudo dpkg -i fridgemanager_1.0.0_amd64.deb
          sudo apt-get install -f
          fridgemanager
          ```
          
          ### Database:
          - Auto-creates database and tables
          - Includes sample products
          - PostgreSQL backend