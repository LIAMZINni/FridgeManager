name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qtbase5-dev \
          qt5-qmake \
          qtdeclarative5-dev \
          libqt5sql5-psql \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql \
          postgresql-client \
          devscripts \
          debhelper \
          dpkg-dev

    - name: ğŸ”§ Build project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: ğŸ“¦ Create package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager

    - name: ğŸ“ Create control file
      run: |
        echo "Package: fridgemanager" > package/DEBIAN/control
        echo "Version: 1.0.0" >> package/DEBIAN/control
        echo "Architecture: amd64" >> package/DEBIAN/control
        echo "Maintainer: GitHub Actions <actions@github.com>" >> package/DEBIAN/control
        echo "Depends: postgresql, libqt5core5, libqt5qml5, libqt5quick5, libqt5sql5-psql, libpq5" >> package/DEBIAN/control
        echo "Section: utils" >> package/DEBIAN/control
        echo "Priority: optional" >> package/DEBIAN/control
        echo "Description: Restaurant fridge manager with PostgreSQL" >> package/DEBIAN/control
        echo " Automatic database setup and product inventory management." >> package/DEBIAN/control

    - name: ğŸ“ Create postinst script
      run: |
        echo "#!/bin/bash" > package/DEBIAN/postinst
        echo "set -e" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"==========================================\"" >> package/DEBIAN/postinst
        echo "echo \"   Setting up FridgeManager\"" >> package/DEBIAN/postinst
        echo "echo \"==========================================\"" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "chmod 755 /usr/bin/fridgemanager" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "if ! command -v psql &> /dev/null; then" >> package/DEBIAN/postinst
        echo "    echo \"PostgreSQL not found!\"" >> package/DEBIAN/postinst
        echo "    exit 1" >> package/DEBIAN/postinst
        echo "fi" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"Starting PostgreSQL...\"" >> package/DEBIAN/postinst
        echo "systemctl start postgresql || true" >> package/DEBIAN/postinst
        echo "systemctl enable postgresql || true" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "sleep 3" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"Creating database...\"" >> package/DEBIAN/postinst
        echo "sudo -u postgres createdb fridgemanager 2>/dev/null && echo \"Database created\" || echo \"Database exists\"" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"Creating products table...\"" >> package/DEBIAN/postinst
        echo "sudo -u postgres psql -d fridgemanager -c \"CREATE TABLE IF NOT EXISTS products (id SERIAL PRIMARY KEY, name VARCHAR(100) UNIQUE NOT NULL, current_quantity INTEGER NOT NULL DEFAULT 0, norm_quantity INTEGER NOT NULL);\" 2>/dev/null && echo \"Table created\" || echo \"Table exists\"" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"Adding sample data...\"" >> package/DEBIAN/postinst
        echo "sudo -u postgres psql -d fridgemanager -c \"INSERT INTO products (name, current_quantity, norm_quantity) VALUES ('Cottage Cheese', 5, 10), ('Cheese', 12, 15), ('Milk', 18, 20), ('Eggs', 25, 30), ('Olives', 3, 8) ON CONFLICT (name) DO NOTHING;\" 2>/dev/null && echo \"Data added\" || echo \"Data exists\"" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"Setup completed! Run: fridgemanager\"" >> package/DEBIAN/postinst

    - name: ğŸ“ Create prerm script
      run: |
        echo "#!/bin/bash" > package/DEBIAN/prerm
        echo "set -e" >> package/DEBIAN/prerm
        echo "" >> package/DEBIAN/prerm
        echo "echo \"==========================================\"" >> package/DEBIAN/prerm
        echo "echo \"   Removing FridgeManager\"" >> package/DEBIAN/prerm
        echo "echo \"==========================================\"" >> package/DEBIAN/prerm
        echo "" >> package/DEBIAN/prerm
        echo "if [ \"\$1\" = \"remove\" ] || [ \"\$1\" = \"deconfigure\" ]; then" >> package/DEBIAN/prerm
        echo "    read -p \"Remove fridgemanager database? [y/N]: \" -n 1 -r" >> package/DEBIAN/prerm
        echo "    echo" >> package/DEBIAN/prerm
        echo "    if [[ \$REPLY =~ ^[Yy]\$ ]]; then" >> package/DEBIAN/prerm
        echo "        echo \"Removing database...\"" >> package/DEBIAN/prerm
        echo "        sudo -u postgres dropdb --if-exists fridgemanager 2>/dev/null || true" >> package/DEBIAN/prerm
        echo "        echo \"Database removed\"" >> package/DEBIAN/prerm
        echo "    fi" >> package/DEBIAN/prerm
        echo "    echo \"Cleaning config files...\"" >> package/DEBIAN/prerm
        echo "    rm -rf /etc/fridgemanager 2>/dev/null || true" >> package/DEBIAN/prerm
        echo "    rm -rf /var/lib/fridgemanager 2>/dev/null || true" >> package/DEBIAN/prerm
        echo "fi" >> package/DEBIAN/prerm
        echo "" >> package/DEBIAN/prerm
        echo "echo \"Cleanup completed\"" >> package/DEBIAN/prerm

    - name: ğŸ“ Copy program files
      run: |
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        chmod 755 package/usr/bin/fridgemanager
        chmod 755 package/DEBIAN/postinst
        chmod 755 package/DEBIAN/prerm

    - name: ğŸ Build deb package
      run: |
        dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
        dpkg --info fridgemanager_1.0.0_amd64.deb
        echo "Package size: $(du -h fridgemanager_1.0.0_amd64.deb | cut -f1)"

    - name: ğŸ§ª Test package installation
      run: |
        echo "Testing package installation..."
        sudo dpkg -i fridgemanager_1.0.0_amd64.deb || true
        sudo apt-get install -f -y
        
        if command -v fridgemanager &> /dev/null; then
            echo "âœ… Program installed successfully"
        else
            echo "âŒ Program installation failed"
            exit 1
        fi

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-deb-package
        path: fridgemanager_1.0.0_amd64.deb
        retention-days: 30