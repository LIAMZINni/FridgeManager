name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package
    runs-on: ubuntu-22.04
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qtbase5-dev \
          qt5-qmake \
          qtdeclarative5-dev \
          qml-module-qtquick2 \
          qml-module-qtquick-window2 \
          qml-module-qtquick-controls2 \
          qml-module-qtquick-layouts \
          qml-module-qtquick-dialogs \
          libqt5sql5-psql \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql \
          postgresql-client \
          devscripts \
          debhelper \
          dpkg-dev

    - name: üîß Build project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: üì¶ Create package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager

    - name: üìù Create control file
      run: |
        # –°–æ–∑–¥–∞–µ–º control —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
        echo "Package: fridgemanager" > package/DEBIAN/control
        echo "Version: 1.0.0" >> package/DEBIAN/control
        echo "Architecture: amd64" >> package/DEBIAN/control
        echo "Maintainer: GitHub Actions <actions@github.com>" >> package/DEBIAN/control
        echo "Depends: postgresql, libqt5core5a, libqt5qml5, libqt5quick5, libqt5sql5-psql, libpq5, qml-module-qtquick2, qml-module-qtquick-window2, qml-module-qtquick-controls2" >> package/DEBIAN/control
        echo "Section: utils" >> package/DEBIAN/control
        echo "Priority: optional" >> package/DEBIAN/control
        echo "Description: Restaurant fridge manager with PostgreSQL" >> package/DEBIAN/control
        echo " Automatic database setup and product inventory management." >> package/DEBIAN/control
        echo " Features:" >> package/DEBIAN/control
        echo "  - Auto-creates PostgreSQL database" >> package/DEBIAN/control
        echo "  - Product inventory tracking" >> package/DEBIAN/control
        echo "  - Supplier order generation" >> package/DEBIAN/control
        echo "  - Modern QML interface" >> package/DEBIAN/control

    - name: üìù Create postinst script
      run: |
        # –°–æ–∑–¥–∞–µ–º postinst —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
        echo "#!/bin/bash" > package/DEBIAN/postinst
        echo "set -e" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo \"==========================================\"" >> package/DEBIAN/postinst
        echo "echo \"   Setting up FridgeManager\"" >> package/DEBIAN/postinst
        echo "echo \"==========================================\"" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "chmod 755 /usr/bin/fridgemanager" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "if ! command -v psql &> /dev/null; then" >> package/DEBIAN/postinst
        echo "    echo 'PostgreSQL not found!'" >> package/DEBIAN/postinst
        echo "    exit 1" >> package/DEBIAN/postinst
        echo "fi" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo 'Starting PostgreSQL...'" >> package/DEBIAN/postinst
        echo "systemctl start postgresql || true" >> package/DEBIAN/postinst
        echo "systemctl enable postgresql || true" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "sleep 5" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo 'Creating database...'" >> package/DEBIAN/postinst
        echo "sudo -u postgres createdb fridgemanager 2>/dev/null && echo 'Database created' || echo 'Database exists'" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo 'Creating products table...'" >> package/DEBIAN/postinst
        echo "sudo -u postgres psql -d fridgemanager -c 'CREATE TABLE IF NOT EXISTS products (id SERIAL PRIMARY KEY, name VARCHAR(100) UNIQUE NOT NULL, current_quantity INTEGER NOT NULL DEFAULT 0, norm_quantity INTEGER NOT NULL);' 2>/dev/null && echo 'Table created' || echo 'Table exists'" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo 'Adding sample data...'" >> package/DEBIAN/postinst
        echo "sudo -u postgres psql -d fridgemanager -c \"INSERT INTO products (name, current_quantity, norm_quantity) VALUES ('–¢–≤–æ—Ä–æ–≥', 5, 10), ('–°—ã—Ä', 12, 15), ('–ú–æ–ª–æ–∫–æ', 18, 20), ('–Ø–π—Ü–∞', 25, 30), ('–û–ª–∏–≤–∫–∏', 3, 8) ON CONFLICT (name) DO NOTHING;\" 2>/dev/null && echo 'Data added' || echo 'Data exists'" >> package/DEBIAN/postinst
        echo "" >> package/DEBIAN/postinst
        echo "echo ''" >> package/DEBIAN/postinst
        echo "echo 'Setup completed!'" >> package/DEBIAN/postinst
        echo "echo 'Run: fridgemanager'" >> package/DEBIAN/postinst
        echo "echo '=========================================='" >> package/DEBIAN/postinst

    - name: üìù Create prerm script
      run: |
        # –°–æ–∑–¥–∞–µ–º prerm —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
        echo "#!/bin/bash" > package/DEBIAN/prerm
        echo "set -e" >> package/DEBIAN/prerm
        echo "" >> package/DEBIAN/prerm
        echo "echo \"==========================================\"" >> package/DEBIAN/prerm
        echo "echo \"   Removing FridgeManager\"" >> package/DEBIAN/prerm
        echo "echo \"==========================================\"" >> package/DEBIAN/prerm
        echo "" >> package/DEBIAN/prerm
        echo "if [ \"\$1\" = \"remove\" ] || [ \"\$1\" = \"deconfigure\" ]; then" >> package/DEBIAN/prerm
        echo "    echo 'Cleaning up...'" >> package/DEBIAN/prerm
        echo "    rm -rf /etc/fridgemanager 2>/dev/null || true" >> package/DEBIAN/prerm
        echo "    rm -rf /var/lib/fridgemanager 2>/dev/null || true" >> package/DEBIAN/prerm
        echo "    rm -rf /tmp/fridgemanager 2>/dev/null || true" >> package/DEBIAN/prerm
        echo "    echo 'Cleanup completed'" >> package/DEBIAN/prerm
        echo "fi" >> package/DEBIAN/prerm

    - name: üìÅ Copy program files
      run: |
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        chmod 755 package/usr/bin/fridgemanager
        chmod 755 package/DEBIAN/postinst
        chmod 755 package/DEBIAN/prerm

    - name: üéÅ Build deb package
      run: |
        dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
        dpkg --info fridgemanager_1.0.0_amd64.deb
        echo "Package size: $(du -h fridgemanager_1.0.0_amd64.deb | cut -f1)"

    - name: üß™ Test package installation
      run: |
        echo "Testing package installation..."
        
        # Install the package
        sudo dpkg -i fridgemanager_1.0.0_amd64.deb || true
        
        # Fix dependencies
        sudo apt-get update
        sudo apt-get install -f -y
        
        # Test if program is installed
        if command -v fridgemanager &> /dev/null; then
            echo "‚úÖ Program installed successfully"
            
            # Test database setup
            echo "Testing database setup..."
            sudo -u postgres psql -d fridgemanager -c "SELECT COUNT(*) FROM products;" && echo "‚úÖ Database accessible" || echo "‚ùå Database error"
            
            # Show products
            echo "Products in database:"
            sudo -u postgres psql -d fridgemanager -c "SELECT name, current_quantity, norm_quantity FROM products;"
            
        else
            echo "‚ùå Program installation failed"
            exit 1
        fi

    - name: üì§ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-deb-package
        path: fridgemanager_1.0.0_amd64.deb
        retention-days: 30