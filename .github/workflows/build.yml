name: Build and Release FridgeManager

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build-linux:
    name: Build .deb package
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qtbase5-dev \
          qt5-qmake \
          qtdeclarative5-dev \
          libqt5sql5-psql \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libpq-dev \
          libpq5 \
          postgresql \
          postgresql-client \
          devscripts \
          debhelper \
          dpkg-dev

    - name: ğŸ”§ Build project
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: ğŸ“¦ Create package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/fridgemanager

    - name: ğŸ“ Create control file
      run: |
        cat > package/DEBIAN/control << 'CONTROL_EOF'
        Package: fridgemanager
        Version: 1.0.0
        Architecture: amd64
        Maintainer: GitHub Actions <actions@github.com>
        Depends: postgresql, libqt5core5, libqt5qml5, libqt5quick5, libqt5sql5-psql, libpq5
        Section: utils
        Priority: optional
        Description: Restaurant fridge manager with PostgreSQL
         Automatic database setup and product inventory management.
        CONTROL_EOF

            - name: ğŸ“ Create postinst script
              run: |
                cat > package/DEBIAN/postinst << 'POSTINST_EOF'
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "   Setting up FridgeManager"
        echo "=========================================="

        chmod 755 /usr/bin/fridgemanager

        if ! command -v psql &> /dev/null; then
            echo "PostgreSQL not found!"
            exit 1
        fi

        echo "Starting PostgreSQL..."
        systemctl start postgresql || true
        systemctl enable postgresql || true

        sleep 3

        echo "Creating database..."
        sudo -u postgres createdb fridgemanager 2>/dev/null && echo "Database created" || echo "Database exists"

        echo "Creating products table..."
        sudo -u postgres psql -d fridgemanager -c "CREATE TABLE IF NOT EXISTS products (id SERIAL PRIMARY KEY, name VARCHAR(100) UNIQUE NOT NULL, current_quantity INTEGER NOT NULL DEFAULT 0, norm_quantity INTEGER NOT NULL);" 2>/dev/null && echo "Table created" || echo "Table exists"

        echo "Adding sample data..."
        sudo -u postgres psql -d fridgemanager -c "INSERT INTO products (name, current_quantity, norm_quantity) VALUES ('Cottage Cheese', 5, 10), ('Cheese', 12, 15), ('Milk', 18, 20), ('Eggs', 25, 30), ('Olives', 3, 8) ON CONFLICT (name) DO NOTHING;" 2>/dev/null && echo "Data added" || echo "Data exists"

        echo "Setup completed! Run: fridgemanager"
        POSTINST_EOF

            - name: ğŸ“ Create prerm script
              run: |
                cat > package/DEBIAN/prerm << 'PRERM_EOF'
        #!/bin/bash
        set -e

        echo "=========================================="
        echo "   Removing FridgeManager"
        echo "=========================================="

        if [ "$1" = "remove" ] || [ "$1" = "deconfigure" ]; then
            read -p "Remove fridgemanager database? [y/N]: " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo "Removing database..."
                sudo -u postgres dropdb --if-exists fridgemanager 2>/dev/null || true
                echo "Database removed"
            fi
            echo "Cleaning config files..."
            rm -rf /etc/fridgemanager 2>/dev/null || true
            rm -rf /var/lib/fridgemanager 2>/dev/null || true
        fi

        echo "Cleanup completed"
        PRERM_EOF

    - name: ğŸ“ Copy program files
      run: |
        cp build/FridgeManager package/usr/bin/fridgemanager
        cp Main.qml package/usr/share/fridgemanager/
        chmod 755 package/usr/bin/fridgemanager
        chmod 755 package/DEBIAN/postinst
        chmod 755 package/DEBIAN/prerm

    - name: ğŸ Build deb package
      run: |
        dpkg-deb --build package fridgemanager_1.0.0_amd64.deb
        dpkg --info fridgemanager_1.0.0_amd64.deb
        echo "Package size: $(du -h fridgemanager_1.0.0_amd64.deb | cut -f1)"

    - name: ğŸ§ª Test package installation
      run: |
        echo "Testing package installation..."
        sudo dpkg -i fridgemanager_1.0.0_amd64.deb || true
        sudo apt-get install -f -y
        
        if command -v fridgemanager &> /dev/null; then
            echo "âœ… Program installed successfully"
        else
            echo "âŒ Program installation failed"
            exit 1
        fi

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: fridgemanager-deb-package
        path: fridgemanager_1.0.0_amd64.deb
        retention-days: 30