#!/bin/bash
set -e

echo "=========================================="
echo "   ÐŸÐ¾Ð»Ð½Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° FridgeManager"
echo "=========================================="

# ðŸ”§ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
install_package() {
    local package=$1
    local description=$2
    
    echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ $description..."
    if dpkg -l | grep -q "^ii  $package "; then
        echo "âœ… $description ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        return 0
    else
        echo "â¬‡ï¸ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ $description..."
        if sudo apt install -y "$package" 2>/dev/null; then
            echo "âœ… $description ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
            return 0
        else
            echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ $package, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñ‹..."
            return 1
        fi
    fi
}

# ðŸ”§ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð° Ñ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð°Ð¼Ð¸
install_package_with_alternatives() {
    local main_package=$1
    local description=$2
    shift 2
    local alternatives=("$@")
    
    if install_package "$main_package" "$description"; then
        return 0
    else
        for alt_package in "${alternatives[@]}"; do
            echo "ðŸ”„ ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñƒ: $alt_package"
            if install_package "$alt_package" "$description (Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð°)"; then
                return 0
            fi
        done
        echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ $description"
        return 1
    fi
}

# ðŸ”§ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´
check_command() {
    local cmd=$1
    local description=$2
    
    if command -v "$cmd" &> /dev/null; then
        echo "âœ… $description Ð½Ð°Ð¹Ð´ÐµÐ½"
        return 0
    else
        echo "âŒ $description Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        return 1
    fi
}

# ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ñ‹
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
sudo apt update

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."

install_package "build-essential" "Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸"
install_package "cmake" "CMake"
install_package "pkg-config" "pkg-config"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Qt5 Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Qt5 Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."

install_package "qt5-default" "Qt5 Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹"
install_package "qtdeclarative5-dev" "Qt5 QML Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð’Ð¡Ð• Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ñ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð°Ð¼Ð¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸..."

# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸
install_package_with_alternatives "qml-module-qtquick2" "QtQuick2 Ð¼Ð¾Ð´ÑƒÐ»ÑŒ"
install_package_with_alternatives "qml-module-qtquick-controls2" "QtQuick Controls2" "qtquickcontrols2-5-dev"
install_package_with_alternatives "qml-module-qtquick-window2" "QtQuick Window2"

# QtQuick Layouts - Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹ Ubuntu
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ QtQuick Layouts..."
if ! install_package "qml-module-qtquick-layouts" "QtQuick Layouts"; then
    echo "ðŸ”„ ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð´Ð»Ñ QtQuick Layouts..."
    install_package "qt5-qmltooling-layouts" "Qt5 QML Layouts" || \
    install_package "libqt5qml5" "Qt5 QML (Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ layouts)" || \
    install_package "qtdeclarative5-dev" "Qt Declarative (ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)" && \
    echo "âš ï¸ QtQuick Layouts Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¿Ð°ÐºÐµÑ‚Ðµ"
fi

install_package_with_alternatives "qml-module-qtquick-templates2" "QtQuick Templates2"
install_package_with_alternatives "qml-module-qtgraphicaleffects" "Qt Graphical Effects" "libqt5graphicaleffects5"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Qt Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Qt Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸..."

install_package "libqt5sql5" "Qt5 SQL Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5sql5-psql" "Qt5 PostgreSQL Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€"
install_package "libqt5core5a" "Qt5 Core Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5gui5" "Qt5 GUI Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5qml5" "Qt5 QML Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5quick5" "Qt5 Quick Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5quickcontrols2-5" "Qt5 Quick Controls2"
install_package "libqt5widgets5" "Qt5 Widgets Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5network5" "Qt5 Network Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5concurrent5" "Qt5 Concurrent Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL..."

install_package "postgresql" "PostgreSQL ÑÐµÑ€Ð²ÐµÑ€"
install_package "postgresql-contrib" "PostgreSQL Ð´Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ"
install_package "libpq-dev" "PostgreSQL Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°"
install_package "libpq5" "PostgreSQL ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ°Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Protocol Buffers
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Protocol Buffers..."

install_package "protobuf-compiler" "Protobuf ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€"
install_package "libprotobuf-dev" "Protobuf Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸"
install_package "libprotoc-dev" "Protobuf ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸..."

install_package "libgl1-mesa-dev" "OpenGL Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸"
install_package "libglu1-mesa-dev" "GLU Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸"

# ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹..."

check_command "g++" "ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€ C++"
check_command "cmake" "CMake"
check_command "qmake" "Qt5 qmake"
check_command "protoc" "Protobuf ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€"
check_command "psql" "PostgreSQL ÐºÐ»Ð¸ÐµÐ½Ñ‚"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ QML Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
cat > /tmp/test_qml_modules.qml << 'EOF'
import QtQuick 2.15
import QtQuick.Controls 2.15
import QtQuick.Layouts 1.15
import QtQuick.Window 2.15

Window {
    width: 400
    height: 300
    visible: true
    title: "QML Modules Test"

    ColumnLayout {
        anchors.fill: parent
        spacing: 10

        Button {
            text: "Test Button"
            Layout.alignment: Qt.AlignCenter
        }

        Label {
            text: "QML modules are working!"
            Layout.alignment: Qt.AlignCenter
        }
    }
}
EOF

echo "âœ… Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ QML Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"

# ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒ Ð´Ð»Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²ÐºÐ¸
echo ""
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒ Ð¸ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²ÐºÑƒ..."
export LANG="ru_RU.UTF-8"
export LC_ALL="ru_RU.UTF-8"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÑƒÑÑÐºÑƒÑŽ Ð»Ð¾ÐºÐ°Ð»ÑŒ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
if ! locale -a | grep -q "ru_RU.utf8"; then
    echo "ðŸ“ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÑƒÑÑÐºÑƒÑŽ Ð»Ð¾ÐºÐ°Ð»ÑŒ..."
    sudo locale-gen ru_RU.UTF-8
    sudo update-locale LANG=ru_RU.UTF-8
fi

# ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL
echo ""
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL..."

echo "ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PostgreSQL..."
sudo systemctl start postgresql || true
sudo systemctl enable postgresql || true

echo "â³ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐº PostgreSQL..."
sleep 3

# ðŸ”‘ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
CURRENT_USER=$(whoami)
echo "ðŸ‘¤ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹: $CURRENT_USER"

# ðŸ”‘ Ð¡ÐžÐ—Ð”ÐÐ•Ðœ ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯ PostgreSQL Ð¡ Ð˜ÐœÐ•ÐÐ•Ðœ Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐžÐ“Ðž ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯
echo "ðŸ”‘ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ PostgreSQL: $CURRENT_USER"
sudo -u postgres createuser --superuser "$CURRENT_USER" 2>/dev/null && echo "âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ $CURRENT_USER ÑÐ¾Ð·Ð´Ð°Ð½" || echo "âš ï¸ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ $CURRENT_USER ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"

# ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ postgres
echo "ðŸ—„ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
sudo -u postgres createdb fridgemanager 2>/dev/null && echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð·Ð´Ð°Ð½Ð°" || echo "ðŸ“ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"

echo "ðŸ“Š Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²..."
sudo -u postgres psql -d fridgemanager -c "
CREATE TABLE IF NOT EXISTS products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    current_quantity INTEGER NOT NULL DEFAULT 0,
    norm_quantity INTEGER NOT NULL
);" 2>/dev/null && echo "âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð°" || echo "ðŸ“‹ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"

# Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð¢Ð•ÐšÐ£Ð©Ð•ÐœÐ£ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE fridgemanager TO $CURRENT_USER;" 2>/dev/null && echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð²Ñ‹Ð´Ð°Ð½Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ $CURRENT_USER" || echo "âš ï¸ ÐŸÑ€Ð°Ð²Ð° ÑƒÐ¶Ðµ Ð²Ñ‹Ð´Ð°Ð½Ñ‹"

# Ð”Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
sudo -u postgres psql -d fridgemanager -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $CURRENT_USER;" 2>/dev/null && echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð²Ñ‹Ð´Ð°Ð½Ñ‹" || echo "âš ï¸ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑƒÐ¶Ðµ Ð²Ñ‹Ð´Ð°Ð½Ñ‹"
sudo -u postgres psql -d fridgemanager -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $CURRENT_USER;" 2>/dev/null && echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð²Ñ‹Ð´Ð°Ð½Ñ‹" || echo "âš ï¸ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ ÑƒÐ¶Ðµ Ð²Ñ‹Ð´Ð°Ð½Ñ‹"

echo "ðŸ“ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ..."
sudo -u postgres psql -d fridgemanager -c "
INSERT INTO products (name, current_quantity, norm_quantity) VALUES
('Ð¢Ð²Ð¾Ñ€Ð¾Ð³', 5, 10),
('Ð¡Ñ‹Ñ€', 12, 15), 
('ÐœÐ¾Ð»Ð¾ÐºÐ¾', 18, 20),
('Ð¯Ð¹Ñ†Ð°', 25, 30),
('ÐžÐ»Ð¸Ð²ÐºÐ¸', 3, 8)
ON CONFLICT (name) DO NOTHING;" 2>/dev/null && echo "âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹" || echo "ðŸ“Š Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚"

# ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ postgres (ÑÐ°Ð¼Ñ‹Ð¹ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±)
if sudo -u postgres psql -d fridgemanager -c "SELECT COUNT(*) FROM products;" &>/dev/null; then
    COUNT=$(sudo -u postgres psql -d fridgemanager -t -c "SELECT COUNT(*) FROM products;" | tr -d ' ')
    echo "âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ postgres: Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢"
    echo "ðŸ“Š ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ð² Ð±Ð°Ð·Ðµ: $COUNT"
else
    echo "âŒ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ postgres: ÐÐ• Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ peer authentication Ð´Ð»Ñ Ð¢Ð•ÐšÐ£Ð©Ð•Ð“Ðž Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
if psql -d fridgemanager -c "SELECT current_user;" &>/dev/null; then
    USER=$(psql -d fridgemanager -t -c "SELECT current_user;" | tr -d ' ')
    echo "âœ… Peer authentication: Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢ (Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $USER)"
else
    echo "âŒ Peer authentication: ÐÐ• Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢ Ð´Ð»Ñ $CURRENT_USER"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ postgres
    if sudo -u postgres psql -d fridgemanager -c "SELECT current_user;" &>/dev/null; then
        echo "âœ… Peer auth (postgres): Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢"
    else
        echo "âŒ Peer auth (postgres): ÐÐ• Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢"
    fi
fi

# ðŸ”§ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo ""
echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."

if [ -d "build" ]; then
    echo "ðŸ“ ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ..."
    rm -rf build
fi

mkdir build
cd build

echo "âš™ï¸ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ CMake..."
if cmake ..; then
    echo "âœ… CMake ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° CMake ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸"
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
    cmake .. 2>&1 | tail -20
    exit 1
fi

echo "ðŸ”¨ ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
if make -j$(nproc); then
    echo "âœ… Ð¡Ð±Ð¾Ñ€ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð°"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸"
    exit 1
fi

# ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ..."

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
sudo cp FridgeManager /usr/bin/fridgemanager
sudo chmod 755 /usr/bin/fridgemanager

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ desktop Ñ„Ð°Ð¹Ð»
echo "ðŸŽ¯ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ€Ð»Ñ‹Ðº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
sudo tee /usr/share/applications/fridgemanager.desktop > /dev/null << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=FridgeManager
Comment=Ð£Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð°
Exec=fridgemanager
Icon=utilities-system-monitor
Categories=Office;
Terminal=false
EOF

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ€Ð»Ñ‹Ðº Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¼ ÑÑ‚Ð¾Ð»Ðµ
echo "ðŸ–¥ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ€Ð»Ñ‹Ðº Ð½Ð° Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¼ ÑÑ‚Ð¾Ð»Ðµ..."
cat > ~/Desktop/FridgeManager.desktop << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=FridgeManager
Comment=Ð£Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð°
Exec=fridgemanager
Icon=utilities-system-monitor
Categories=Office;
Terminal=false
EOF
chmod +x ~/Desktop/FridgeManager.desktop

echo ""
echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ PostgreSQL: $CURRENT_USER"
echo "ðŸ’¡ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑÑ ÐºÐ°Ðº: $CURRENT_USER"
echo "ðŸ“ Ð˜ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»: /usr/bin/fridgemanager"
echo "ðŸ–¥ï¸  Ð¯Ñ€Ð»Ñ‹Ðº: ÐœÐµÐ½ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ â†’ FridgeManager"
echo "ðŸ–¥ï¸  Ð¯Ñ€Ð»Ñ‹Ðº: Ð Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ ÑÑ‚Ð¾Ð» â†’ FridgeManager"
echo "âž¡ï¸  Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: fridgemanager"
echo "   Ð¸Ð»Ð¸ Ð½Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð² Ð¼ÐµÐ½ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹"
echo "=========================================="

# ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
echo ""
read -p "ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ FridgeManager ÑÐµÐ¹Ñ‡Ð°Ñ? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ FridgeManager..."
    fridgemanager
fi
