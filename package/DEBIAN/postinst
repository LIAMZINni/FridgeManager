#!/bin/bash
set -e

echo "=========================================="
echo "   Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° FridgeManager (Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐÐ¯)"
echo "=========================================="

# ðŸ”§ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
install_package() {
    local package=$1
    local description=$2
    
    echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ $description..."
    if dpkg -l | grep -q "^ii  $package "; then
        echo "âœ… $description ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        return 0
    else
        echo "â¬‡ï¸ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ $description..."
        if sudo apt install -y "$package" 2>/dev/null; then
            echo "âœ… $description ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
            return 0
        else
            echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ $package"
            return 1
        fi
    fi
}

# ðŸ”§ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐÐ¯ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ QtQuick Layouts
install_qtquick_layouts_comprehensive() {
    echo ""
    echo "ðŸ”§ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: Ð˜Ñ‰ÐµÐ¼ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ QtQuick Layouts"
    
    # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÑ‘
    sudo apt update
    
    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð’Ð¡Ð•Ð¥ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ QtQuick Layouts
    local layout_packages=(
        "qml-module-qtquick-layouts"
        "qtdeclarative5-layouts-plugin"
        "libqt5quicklayouts5"
        "qt5-qmltooling-layouts"
        "qml-module-qt-labs-layouts"
        "qtquickcontrols2-5-dev"
        "qml-module-qtquick-controls2"
        "qml-module-qtquick-dialogs"
        "qml-module-qtquick-privatewidgets"
    )
    
    # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚
    for pkg in "${layout_packages[@]}"; do
        echo "ðŸ”„ ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼: $pkg"
        if sudo apt install -y "$pkg" 2>/dev/null; then
            echo "âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: $pkg"
            return 0
        fi
    done
    
    # Ð•ÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¿Ð¾Ð¼Ð¾Ð³Ð»Ð¾, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð’Ð¡Ð• qml Ð¼Ð¾Ð´ÑƒÐ»Ð¸
    echo "ðŸ”„ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð’Ð¡Ð• qml-module-qtquick* Ð¿Ð°ÐºÐµÑ‚Ñ‹..."
    sudo apt install -y qml-module-qtquick* 2>/dev/null || true
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚ÑŒ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¾ÑÑŒ
    if dpkg -l | grep -q "qml-module"; then
        echo "âœ… ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
        return 0
    else
        echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ QtQuick Layouts"
        return 1
    fi
}

# ðŸ”§ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ QML Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ
check_qml_modules() {
    echo ""
    echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… QML Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹..."
    
    # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ Ð³Ð´Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸
    local qml_paths=(
        "/usr/lib/x86_64-linux-gnu/qt5/qml"
        "/usr/lib/qt5/qml"
        "/usr/lib/x86_64-linux-gnu/qt6/qml"
        "/usr/lib/qt6/qml"
    )
    
    for path in "${qml_paths[@]}"; do
        if [ -d "$path" ]; then
            echo "ðŸ“ QML path: $path"
            if [ -d "$path/QtQuick/Layouts" ] || [ -d "$path/QtQuick/Layouts.2" ]; then
                echo "âœ… QtQuick.Layouts Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² $path"
                return 0
            fi
        fi
    done
    
    echo "âŒ QtQuick.Layouts Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ"
    return 1
}

# ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ñ‹
echo "ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
sudo apt update

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."

install_package "build-essential" "Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸"
install_package "cmake" "CMake"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Qt5 Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Qt5 Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."

install_package "qt5-default" "Qt5 Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹"
install_package "qtdeclarative5-dev" "Qt5 QML Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• QML Ð¼Ð¾Ð´ÑƒÐ»Ð¸..."

install_package "qml-module-qtquick2" "QtQuick2 Ð¼Ð¾Ð´ÑƒÐ»ÑŒ"
install_package "qml-module-qtquick-controls2" "QtQuick Controls2"
install_package "qml-module-qtquick-window2" "QtQuick Window2"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ QtQuick Layouts Ð’Ð¡Ð•ÐœÐ˜ ÑÐ¿Ð¾ÑÐ¾Ð±Ð°Ð¼Ð¸
install_qtquick_layouts_comprehensive

# ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»Ð¾ÑÑŒ
check_qml_modules

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Qt Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Qt Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸..."

install_package "libqt5sql5" "Qt5 SQL Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5sql5-psql" "Qt5 PostgreSQL Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€"
install_package "libqt5core5a" "Qt5 Core Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5gui5" "Qt5 GUI Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5qml5" "Qt5 QML Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5quick5" "Qt5 Quick Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"
install_package "libqt5widgets5" "Qt5 Widgets Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"

# ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL..."

install_package "postgresql" "PostgreSQL ÑÐµÑ€Ð²ÐµÑ€"
install_package "libpq-dev" "PostgreSQL Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°"
install_package "libpq5" "PostgreSQL ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ°Ñ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°"

# ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL
echo ""
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ PostgreSQL..."

sudo systemctl start postgresql || true
sleep 2

CURRENT_USER=$(whoami)
echo "ðŸ‘¤ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $CURRENT_USER"

sudo -u postgres createuser --superuser "$CURRENT_USER" 2>/dev/null || true
sudo -u postgres createdb fridgemanager 2>/dev/null || true

# ðŸ”§ ÐŸÐ•Ð Ð•Ð¡Ð‘Ð˜Ð ÐÐ•Ðœ ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð• Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿ÑƒÑ‚ÑÐ¼Ð¸
echo ""
echo "ðŸ”¨ ÐŸÐµÑ€ÐµÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."

if [ -d "build" ]; then
    rm -rf build
fi

mkdir build
cd build

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ CMakeLists.txt ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
cat > ../CMakeLists_fixed.txt << 'EOF'
cmake_minimum_required(VERSION 3.16)
project(FridgeManager)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

find_package(Qt5 COMPONENTS Core Quick Qml Sql REQUIRED)
find_package(PostgreSQL)

add_executable(FridgeManager
    main.cpp
    DatabaseManager.cpp
    DatabaseManager.h
)

target_link_libraries(FridgeManager
    Qt5::Core
    Qt5::Quick
    Qt5::Qml
    Qt5::Sql
)

if(PostgreSQL_FOUND)
    target_link_libraries(FridgeManager ${PostgreSQL_LIBRARIES})
    target_include_directories(FridgeManager PRIVATE ${PostgreSQL_INCLUDE_DIRS})
endif()

# Ð£ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ Ð´Ð»Ñ QML
if(EXISTS "/usr/lib/x86_64-linux-gnu/qt5/qml")
    set(QML_IMPORT_PATH "/usr/lib/x86_64-linux-gnu/qt5/qml")
elseif(EXISTS "/usr/lib/qt5/qml")
    set(QML_IMPORT_PATH "/usr/lib/qt5/qml")
endif()

if(QML_IMPORT_PATH)
    target_compile_definitions(FridgeManager PRIVATE QML_IMPORT_PATH="${QML_IMPORT_PATH}")
endif()
EOF

echo "âš™ï¸ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ CMake..."
cmake ..

echo "ðŸ”¨ ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
make -j$(nproc)

# ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo ""
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ..."

sudo cp FridgeManager /usr/bin/fridgemanager
sudo chmod 755 /usr/bin/fridgemanager

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ desktop Ñ„Ð°Ð¹Ð»
sudo tee /usr/share/applications/fridgemanager.desktop > /dev/null << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=FridgeManager
Comment=Ð£Ñ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð°
Exec=fridgemanager
Icon=utilities-system-monitor
Categories=Office;
Terminal=false
EOF

echo ""
echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "âž¡ï¸  Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: fridgemanager"
echo "=========================================="

# ðŸ”§ Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
echo ""
echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº..."
if fridgemanager; then
    echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¾ÑÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°, Ð½Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾"
fi
