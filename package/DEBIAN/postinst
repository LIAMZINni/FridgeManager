#!/bin/bash
set -e

echo "=========================================="
echo "   Настройка FridgeManager"
echo "=========================================="

chmod 755 /usr/bin/fridgemanager

if ! command -v psql &> /dev/null; then
    echo "❌ PostgreSQL не установлен!"
    exit 1
fi

echo "🔧 Запускаем PostgreSQL..."
systemctl start postgresql || true
systemctl enable postgresql || true

echo "⏳ Ожидаем запуск PostgreSQL..."
sleep 5

# 🔧 ВАЖНО: Настраиваем peer authentication для текущего пользователя
echo "🔧 Настраиваем Peer Authentication..."
PG_HBA_FILE=$(find /etc/postgresql -name "pg_hba.conf" | head -1)

if [ -f "$PG_HBA_FILE" ]; then
    echo "📁 Найден файл: $PG_HBA_FILE"
    
    # Делаем резервную копию
    sudo cp "$PG_HBA_FILE" "${PG_HBA_FILE}.backup"
    echo "✅ Создана резервная копия"
    
    # Восстанавливаем стандартные настройки с peer auth
    cat << 'EOF' | sudo tee "$PG_HBA_FILE" > /dev/null
# PostgreSQL Client Authentication Configuration File
# ===================================================
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             postgres                                peer
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
local   replication     all                                     peer
host    replication     all             127.0.0.1/32            md5
host    replication     all             ::1/128                 md5
EOF

    echo "✅ Peer authentication настроена"
    
    # Перезапускаем PostgreSQL
    sudo systemctl restart postgresql
    sleep 3
    echo "✅ PostgreSQL перезапущен"
else
    echo "❌ Файл pg_hba.conf не найден!"
    exit 1
fi

# 🔑 СОЗДАЕМ ПОЛЬЗОВАТЕЛЯ С ИМЕНЕМ ТЕКУЩЕГО СИСТЕМНОГО ПОЛЬЗОВАТЕЛЯ
CURRENT_USER=$(whoami)
echo "🔑 Создаем пользователя БД: $CURRENT_USER"
sudo -u postgres psql -c "CREATE USER $CURRENT_USER WITH SUPERUSER;" 2>/dev/null && echo "✅ Пользователь создан: $CURRENT_USER" || echo "⚠️ Пользователь уже существует"

# Создаем базу данных
echo "🗄️ Создаем базу данных..."
sudo -u postgres createdb fridgemanager 2>/dev/null && echo "✅ База данных создана" || echo "📁 База данных уже существует"

# Даем права текущему пользователю
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE fridgemanager TO $CURRENT_USER;" 2>/dev/null && echo "✅ Права на БД выданы" || echo "⚠️ Права уже выданы"

echo "📊 Создаем таблицу продуктов..."
sudo -u postgres psql -d fridgemanager -c "
CREATE TABLE IF NOT EXISTS products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    current_quantity INTEGER NOT NULL DEFAULT 0,
    norm_quantity INTEGER NOT NULL
);" 2>/dev/null && echo "✅ Таблица создана" || echo "📋 Таблица уже существует"

# Даем права на таблицу
sudo -u postgres psql -d fridgemanager -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $CURRENT_USER;" 2>/dev/null && echo "✅ Права на таблицы выданы" || echo "⚠️ Права уже выданы"
sudo -u postgres psql -d fridgemanager -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $CURRENT_USER;" 2>/dev/null && echo "✅ Права на последовательности выданы" || echo "⚠️ Права уже выданы"

echo "📝 Добавляем тестовые данные..."
sudo -u postgres psql -d fridgemanager -c "
INSERT INTO products (name, current_quantity, norm_quantity) VALUES
('Творог', 5, 10),
('Сыр', 12, 15), 
('Молоко', 18, 20),
('Яйца', 25, 30),
('Оливки', 3, 8)
ON CONFLICT (name) DO NOTHING;" 2>/dev/null && echo "✅ Данные добавлены" || echo "📊 Данные уже существуют"

echo "🔍 Проверяем подключения..."

# Проверяем peer authentication (без указания пользователя)
if psql -d fridgemanager -c "SELECT current_user, COUNT(*) FROM products;" &>/dev/null; then
    echo "✅ Peer authentication: РАБОТАЕТ"
    PRODUCT_COUNT=$(psql -d fridgemanager -t -c "SELECT COUNT(*) FROM products;" | tr -d ' ')
    echo "📊 Продуктов в базе: $PRODUCT_COUNT"
    echo "👤 Текущий пользователь: $CURRENT_USER"
else
    echo "❌ Peer authentication: НЕ РАБОТАЕТ"
    echo "Пробуем с пользователем postgres..."
    if sudo -u postgres psql -d fridgemanager -c "SELECT current_user;" &>/dev/null; then
        echo "✅ Peer auth (postgres): РАБОТАЕТ"
    else
        echo "❌ Peer auth (postgres): НЕ РАБОТАЕТ"
    fi
fi

echo ""
echo "🎉 Установка завершена!"
echo "🔐 Peer authentication активирована"
echo "   Пользователь: $CURRENT_USER (системный)"
echo "   Пароль: НЕ ТРЕБУЕТСЯ"
echo "   База данных: fridgemanager"
echo "➡️ Запустите: fridgemanager"
echo "=========================================="